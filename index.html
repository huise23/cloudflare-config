<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare é…ç½®ä¸­å¿ƒ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™ï¸</text></svg>">
    <style>
        /* --- å…¨å±€ä¸å­—ä½“ --- */
        :root {
            /* ä¸»è‰²è°ƒ - ç°ä»£ç´«è“æ¸å˜ */
            --primary-color: #667eea;
            --primary-hover: #5a67d8;
            --primary-light: rgba(102, 126, 234, 0.1);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-gradient-hover: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);

            /* åŠŸèƒ½è‰² */
            --success-color: #10b981;
            --success-light: rgba(16, 185, 129, 0.1);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);

            --danger-color: #ef4444;
            --danger-light: rgba(239, 68, 68, 0.1);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);

            --warning-color: #f59e0b;
            --warning-light: rgba(245, 158, 11, 0.1);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);

            --info-color: #06b6d4;
            --info-light: rgba(6, 182, 212, 0.1);
            --info-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);

            /* ä¸­æ€§è‰² */
            --bg-primary: #ffffff;
            --bg-secondary: rgba(248, 250, 252, 0.8);
            --bg-tertiary: rgba(241, 245, 249, 0.6);
            --bg-glass: rgba(255, 255, 255, 0.25);
            --bg-glass-hover: rgba(255, 255, 255, 0.35);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;

            /* è¾¹æ¡†ä¸é˜´å½± */
            --border-color: rgba(226, 232, 240, 0.8);
            --border-glass: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
            --shadow-glass: 0 8px 32px rgba(102, 126, 234, 0.15);

            /* åœ†è§’ */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 24px;

            /* æ¯›ç»ç’ƒæ•ˆæœ */
            --blur-sm: blur(8px);
            --blur-md: blur(16px);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 1rem;
            background-attachment: fixed;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(102, 126, 234, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            backdrop-filter: var(--blur-md);
            -webkit-backdrop-filter: var(--blur-md);
            border: 1px solid var(--border-glass);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border-glass) 50%, transparent 100%);
        }

        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-glass);
            position: relative;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin: 0;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .header p {
            color: var(--text-muted);
            margin-top: 0.75rem;
            font-size: 1.2rem;
            font-weight: 500;
            opacity: 0.8;
        }

        /* --- æ ‡é¢˜ä¸åˆ†éš”ç¬¦ --- */
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 3rem 0 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        h2::before {
            content: '';
            width: 5px;
            height: 28px;
            background: var(--primary-gradient);
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        h3, h4 {
            color: var(--text-secondary);
            font-weight: 600;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--border-glass);
            margin: 3rem 0;
        }

        /* --- è¡¨å•ä¸è¾“å…¥æ¡† --- */
        .form-section {
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border-glass) 50%, transparent 100%);
        }

        .form-section:hover {
            box-shadow: var(--shadow-glass);
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-glass);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-primary);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-light);
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
            line-height: 1.6;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.25rem center;
            padding-right: 3rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        /* --- æŒ‰é’® --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            background: var(--primary-gradient-hover);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: var(--bg-glass);
            color: var(--text-secondary);
            border: 1px solid var(--border-glass);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .btn-secondary:hover {
            background: var(--bg-glass-hover);
            border-color: var(--primary-light);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
        }

        .btn-sm {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        /* --- è¡¨æ ¼ --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: var(--bg-glass);
            border-radius: var(--radius-lg);
            overflow: hidden;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-glass);
        }

        th, td {
            text-align: left;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-glass);
        }

        th {
            background: var(--bg-glass-hover);
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-glass-hover);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        td .actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .key-cell {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 600;
            color: var(--primary-color);
            background: var(--primary-light);
            padding: 0.5rem 0.75rem !important;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .value-comment-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .config-value-display, .config-comment-display {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--radius-sm);
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.95em;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            border: 1px solid var(--border-glass);
        }

        .config-comment-display {
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.9em;
            border-left: 3px solid var(--primary-color);
            background: var(--primary-light);
        }

        .config-comment-display:empty {
            display: none;
        }

        /* --- å¸ƒå°”å€¼æ»‘åŠ¨å¼€å…³ --- */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--text-muted);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 32px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        input:checked + .slider {
            background: var(--success-gradient);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* --- æ¶ˆæ¯æç¤º --- */
        #configFormContainer, #clashRulesEditor {
            display: none;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .status-message {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
            font-size: 1.1rem;
            background: var(--bg-glass);
            border-radius: var(--radius-lg);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            border: 1px solid var(--border-glass);
        }

        .message-box {
            padding: 1.25rem 1.75rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            display: none;
            animation: messageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            box-shadow: var(--shadow-md);
            font-weight: 500;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(-15px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-box.success {
            background: rgba(16, 185, 129, 0.15);
            color: #065f46;
            border-left-color: var(--success-color);
        }

        .message-box.error {
            background: rgba(239, 68, 68, 0.15);
            color: #991b1b;
            border-left-color: var(--danger-color);
        }

        .message-box.info {
            background: rgba(6, 182, 212, 0.15);
            color: #155e75;
            border-left-color: var(--info-color);
        }

        /* --- ç±»å‹æ ‡ç­¾ --- */
        .type-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .type-common {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .type-clash-yml {
            background: rgba(245, 158, 11, 0.2);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .type-clash-github-url {
            background: rgba(6, 182, 212, 0.2);
            color: #155e75;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        /* --- ç§»åŠ¨ç«¯ä¼˜åŒ– --- */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .container {
                padding: 1.5rem;
                margin: 0;
                border-radius: var(--radius-lg);
            }

            .header h1 {
                font-size: 2.25rem;
            }

            .header p {
                font-size: 1.1rem;
            }

            .action-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .action-bar h2 {
                width: 100%;
                margin: 1.5rem 0 1rem 0;
            }

            .action-bar .btn {
                width: 100%;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 1rem 0.75rem;
            }

            td .actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .value-comment-container {
                font-size: 0.9em;
            }

            .form-section {
                padding: 1.5rem;
            }

            .btn {
                padding: 0.875rem 1.25rem;
            }
        }

        /* --- åŠ è½½åŠ¨ç”» --- */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-glass);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Clash è§„åˆ™ç¼–è¾‘å™¨æ ·å¼ --- */
        .rule-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
            position: relative;
            overflow: hidden;
        }

        .rule-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border-glass) 50%, transparent 100%);
        }

        .rule-item:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            background: var(--bg-glass-hover);
        }

        .rule-item.disabled {
            opacity: 0.6;
            background: rgba(148, 163, 184, 0.1);
        }

        .rule-toggle {
            display: flex;
            align-items: center;
        }

        .rule-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .rule-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .rule-type-tag {
            display: inline-block;
            padding: 0.4rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            white-space: nowrap;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .rule-type-DOMAIN-SUFFIX {
            background: rgba(6, 182, 212, 0.2);
            color: #155e75;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .rule-type-DOMAIN {
            background: rgba(16, 185, 129, 0.2);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .rule-type-DOMAIN-KEYWORD {
            background: rgba(245, 158, 11, 0.2);
            color: #92400e;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .rule-type-IP-CIDR {
            background: rgba(239, 68, 68, 0.2);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .rule-type-GEOIP {
            background: rgba(139, 92, 246, 0.2);
            color: #7c3aed;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .rule-type-SRC-IP-CIDR {
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .rule-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.95rem;
            color: var(--text-primary);
            flex: 1;
            min-width: 150px;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--radius-sm);
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .rule-arrow {
            color: var(--text-muted);
            font-size: 1.4rem;
            font-weight: 600;
        }

        .rule-policy {
            font-weight: 700;
            color: var(--primary-color);
            padding: 0.5rem 0.75rem;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            backdrop-filter: var(--blur-sm);
            -webkit-backdrop-filter: var(--blur-sm);
        }

        .rule-actions {
            display: flex;
            gap: 0.75rem;
        }

        .clash-rule-form {
            margin-bottom: 2rem;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .rule-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem;
            }

            .rule-content {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .rule-value {
                width: 100%;
                min-width: unset;
            }

            .rule-actions {
                width: 100%;
                justify-content: flex-end;
                gap: 0.5rem;
            }

            .rule-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš™ï¸ Cloudflare é…ç½®ä¸­å¿ƒ</h1>
            <p>ç®€å•ã€å®‰å…¨çš„é…ç½®ç®¡ç†å¹³å°</p>
        </div>

        <div class="form-section">
            <label for="authToken">ğŸ” è®¤è¯ä»¤ç‰Œ (Auth Token)</label>
            <input type="password" id="authToken" placeholder="è¾“å…¥ä½ çš„ç§˜å¯†ä»¤ç‰Œä»¥åŠ è½½å’Œç®¡ç†é…ç½®">
        </div>

        <div id="messageBox" class="message-box"></div>

        <div class="action-bar">
            <h2>ğŸ“‹ é…ç½®åˆ—è¡¨</h2>
            <button id="showAddFormBtn" class="btn btn-primary">â• æ–°å¢é…ç½®</button>
        </div>

        <div id="configFormContainer" class="form-section">
            <h3 id="formTitle">æ–°å¢é…ç½®</h3>
            <form id="configForm">
                <div class="form-group">
                    <label for="configType">é…ç½®ç±»å‹</label>
                    <select id="configType" required>
                        <option value="common">é€šç”¨é…ç½® (common)</option>
                        <option value="clash-yml">Clash YAML è§„åˆ™ (clash-yml)</option>
                        <option value="clash-github-url">Clash è¿œç¨‹é“¾æ¥ (clash-github-url)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="configKey">é…ç½®é”® (Key)</label>
                    <input type="text" id="configKey" required>
                </div>
                <div class="form-group" id="valueGroup">
                    <label for="configValue">é…ç½®å€¼ (Value)</label>
                    <textarea id="configValue" rows="5" placeholder="æ ¹æ®ç±»å‹ä¸åŒï¼Œæ­¤å­—æ®µç”¨é€”ä¹Ÿä¸åŒ"></textarea>
                </div>
                <div class="form-group">
                    <label for="configComment">æ³¨é‡Š (Comment)</label>
                    <textarea id="configComment" rows="3" placeholder="å¯é€‰ï¼šæ·»åŠ å…³äºæ­¤é…ç½®çš„è¯´æ˜æˆ–å¤‡æ³¨"></textarea>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

        <!-- Clash è§„åˆ™ç¼–è¾‘å™¨ (é»˜è®¤éšè—) -->
        <div id="clashRulesEditor" class="form-section" style="display: none;">
            <h3>ğŸ¯ Clash è§„åˆ™å¿«é€Ÿæ·»åŠ </h3>
            <div style="background: var(--info-light); padding: 0.75rem; border-radius: var(--radius-sm); margin-bottom: 1rem; font-size: 0.9rem; color: #155e75;">
                ğŸ’¡ <strong>ä½¿ç”¨æç¤º</strong>ï¼šé€‰æ‹©è§„åˆ™ç±»å‹ â†’ è¾“å…¥è§„åˆ™å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œæ‰¹é‡æ·»åŠ ï¼‰â†’ é€‰æ‹©ä»£ç†ç­–ç•¥ â†’ ç‚¹å‡»"æ·»åŠ è§„åˆ™"ã€‚å®Œæˆåç‚¹å‡»"ä¿å­˜åˆ°é…ç½®"ã€‚<br>
                <strong style="color: #c2410c;">âš ï¸ é‡è¦</strong>ï¼šå¦‚æœæ˜¯æ–°å¢é…ç½®ï¼Œè¯·å…ˆåœ¨è¡¨å•ä¸­å¡«å†™"é…ç½®é”®"ï¼Œç„¶åç‚¹å‡»"ä¿å­˜åˆ°é…ç½®"ã€‚
            </div>
            <div class="clash-rule-form">
                <div class="form-group">
                    <label for="ruleType">è§„åˆ™ç±»å‹</label>
                    <select id="ruleType" onchange="updateRulePlaceholder()">
                        <option value="DOMAIN-SUFFIX">DOMAIN-SUFFIX (åŸŸååç¼€)</option>
                        <option value="DOMAIN">DOMAIN (ç²¾ç¡®åŸŸå)</option>
                        <option value="DOMAIN-KEYWORD">DOMAIN-KEYWORD (åŸŸåå…³é”®å­—)</option>
                        <option value="IP-CIDR">IP-CIDR (IP æ®µ)</option>
                        <option value="GEOIP">GEOIP (å›½å®¶ä»£ç )</option>
                        <option value="SRC-IP-CIDR">SRC-IP-CIDR (æº IP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ruleValue">
                        è§„åˆ™å†…å®¹
                        <button type="button" class="btn btn-secondary btn-sm" onclick="fillRuleExample()" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                            ğŸ“ å¡«å……ç¤ºä¾‹
                        </button>
                    </label>
                    <textarea id="ruleValue" rows="4" placeholder="ä¾‹å¦‚: google.com æˆ– 192.168.1.0/24&#10;&#10;ğŸ’¡ æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œæ¯è¡Œè‡ªåŠ¨ç”Ÿæˆä¸€æ¡è§„åˆ™"></textarea>
                    <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;">
                        ğŸ’¡ <strong>æ‰¹é‡æ·»åŠ </strong>ï¼šæ¯è¡Œè¾“å…¥ä¸€ä¸ªè§„åˆ™å†…å®¹ï¼Œè‡ªåŠ¨ç”Ÿæˆå¤šæ¡è§„åˆ™
                    </small>
                </div>
                <div class="form-group">
                    <label for="rulePolicy">ä»£ç†ç­–ç•¥</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="rulePolicy" style="flex: 1;">
                            <option value="DIRECT">DIRECT</option>
                            <option value="REJECT">REJECT</option>
                        </select>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="refreshPolicies()" title="ä» clash-github-url é…ç½®åŠ è½½ç­–ç•¥åˆ—è¡¨">
                            ğŸ”„ åˆ·æ–°ç­–ç•¥
                        </button>
                    </div>
                    <small style="color: var(--text-muted); margin-top: 0.25rem; display: block;" id="policySourceInfo">
                        ğŸ’¡ æç¤ºï¼šåˆ›å»ºä¸€ä¸ª clash-github-url ç±»å‹çš„é…ç½®ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°ç­–ç•¥"æŒ‰é’®è‡ªåŠ¨åŠ è½½ä»£ç†ç­–ç•¥
                    </small>
                </div>
                <div style="margin-top: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="addRule()">+ æ·»åŠ è§„åˆ™</button>
                </div>
            </div>

            <hr style="margin: 2rem 0;">

            <h4>ğŸ“‹ è§„åˆ™åˆ—è¡¨ <span id="ruleCount" style="font-weight: normal; font-size: 0.9em; color: var(--text-muted);"></span></h4>
            <div id="rulesListContainer" style="max-height: 400px; overflow-y: auto;">
                <div id="noRulesMessage" style="text-align: center; padding: 2rem; color: var(--text-muted); display: none;">
                    æš‚æ— è§„åˆ™ï¼Œè¯·æ·»åŠ 
                </div>
                <div id="rulesList"></div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary" onclick="exportRulesAsYAML()">ğŸ“¤ å¯¼å‡º YAML</button>
                <button type="button" class="btn btn-secondary" onclick="saveRulesToConfig()">ğŸ’¾ ä¿å­˜åˆ°é…ç½®</button>
            </div>
        </div>

        <div id="configListContainer">
            <div id="statusMessage" class="status-message">è¯·è¾“å…¥è®¤è¯ä»¤ç‰Œä»¥åŠ è½½é…ç½®åˆ—è¡¨ã€‚</div>
            <table>
                <thead id="configListHead" style="display:none;">
                    <tr>
                        <th style="width: 25%;">é…ç½®é”® (Key)</th>
                        <th>é…ç½®å€¼ä¸æ³¨é‡Š (Value & Comment)</th>
                        <th style="width: 150px;">æ“ä½œ (Actions)</th>
                    </tr>
                </thead>
                <tbody id="configListBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const WORKER_URL = '/api/config'; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œç”± Pages é‡å†™è§„åˆ™å¤„ç†
        // å‡è®¾ Worker å­˜å‚¨çš„ KV æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š
        // { "value": "actual_value", "comment": "some_comment" }
        // æˆ–ç›´æ¥å­˜å‚¨ "actual_value"

        // DOM Elements
        const authTokenInput = document.getElementById('authToken');
        const showAddFormBtn = document.getElementById('showAddFormBtn');
        const configFormContainer = document.getElementById('configFormContainer');
        const clashRulesEditor = document.getElementById('clashRulesEditor');
        const formTitle = document.getElementById('formTitle');
        const configForm = document.getElementById('configForm');
        const configTypeInput = document.getElementById('configType');
        const configKeyInput = document.getElementById('configKey');
        const configValueInput = document.getElementById('configValue');
        const configCommentInput = document.getElementById('configComment'); // æ–°å¢æ³¨é‡Šè¾“å…¥æ¡†
        const configListHead = document.getElementById('configListHead');
        const configListBody = document.getElementById('configListBody');
        const statusMessage = document.getElementById('statusMessage');
        const messageBox = document.getElementById('messageBox');

        let isEditing = false;

        // --- Event Listeners ---
        // ç±»å‹é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
        configTypeInput.addEventListener('change', () => {
            const selectedType = configTypeInput.value;
            const valueGroup = document.getElementById('valueGroup');

            if (selectedType === 'clash-yml') {
                // Clash YAML ç±»å‹ï¼šéšè—å€¼è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºè§„åˆ™ç¼–è¾‘å™¨
                valueGroup.style.display = 'none';
                // å»¶è¿Ÿæ˜¾ç¤ºï¼Œç­‰å¾…è¡¨å•å¯è§
                setTimeout(() => {
                    const key = configKeyInput.value.trim();
                    // æ— è®ºæ˜¯å¦å·²è¾“å…¥ keyï¼Œéƒ½æ˜¾ç¤ºè§„åˆ™ç¼–è¾‘å™¨
                    openClashRulesEditor(isEditing ? key : null);
                }, 100);
            } else if (selectedType === 'clash-github-url') {
                // Clash URL ç±»å‹ï¼šæ˜¾ç¤ºå€¼è¾“å…¥æ¡†ï¼Œéšè—è§„åˆ™ç¼–è¾‘å™¨
                valueGroup.style.display = 'block';
                configValueInput.placeholder = 'è¾“å…¥ Clash é…ç½®çš„ URL é“¾æ¥';
                closeClashRulesEditor();
            } else {
                // é€šç”¨ç±»å‹ï¼šæ˜¾ç¤ºå€¼è¾“å…¥æ¡†ï¼Œéšè—è§„åˆ™ç¼–è¾‘å™¨
                valueGroup.style.display = 'block';
                configValueInput.placeholder = 'æ ¹æ®ç±»å‹ä¸åŒï¼Œæ­¤å­—æ®µç”¨é€”ä¹Ÿä¸åŒ';
                closeClashRulesEditor();
            }
        });

        // --- Event Listeners ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('configAuthToken');
            if (savedToken) {
                authTokenInput.value = savedToken;
                fetchConfigList();
            }

            // åˆå§‹åŒ–è§„åˆ™è¾“å…¥æ¡†å ä½ç¬¦
            updateRulePlaceholder();
        });

        authTokenInput.addEventListener('change', () => {
            localStorage.setItem('configAuthToken', authTokenInput.value);
            fetchConfigList();
        });

        showAddFormBtn.addEventListener('click', () => {
            isEditing = false;
            formTitle.textContent = 'æ–°å¢é…ç½®';
            configTypeInput.value = 'common';
            configKeyInput.value = '';
            configValueInput.value = '';
            configCommentInput.value = ''; // æ¸…ç©ºæ³¨é‡Š
            configKeyInput.disabled = false;
            configTypeInput.disabled = false;
            configFormContainer.style.display = 'block';

            // ç¡®ä¿ valueGroup æ­£ç¡®æ˜¾ç¤º
            const valueGroup = document.getElementById('valueGroup');
            valueGroup.style.display = 'block';
            configValueInput.placeholder = 'æ ¹æ®ç±»å‹ä¸åŒï¼Œæ­¤å­—æ®µç”¨é€”ä¹Ÿä¸åŒ';
            closeClashRulesEditor();

            configKeyInput.focus();
        });

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const key = configKeyInput.value.trim();
            const type = configTypeInput.value;
            const comment = configCommentInput.value;
            if (!key) {
                showMessage('è¯·è¾“å…¥é…ç½®é”®', 'error');
                return;
            }

            let payload;

            if (type === 'clash-yml') {
                // Clash YAML ç±»å‹ï¼šä½¿ç”¨è§„åˆ™ç¼–è¾‘å™¨ä¸­çš„è§„åˆ™
                if (clashRules.length === 0) {
                    showMessage('è¯·æ·»åŠ è‡³å°‘ä¸€æ¡è§„åˆ™', 'error');
                    return;
                }
                payload = JSON.stringify({
                    type: type,
                    value: {
                        rules: clashRules
                    },
                    comment: comment || `Clash è§„åˆ™é…ç½® (${clashRules.length} æ¡)`
                });
                closeClashRulesEditor();
            } else {
                // å…¶ä»–ç±»å‹ï¼šä½¿ç”¨å€¼è¾“å…¥æ¡†çš„å†…å®¹
                const value = configValueInput.value;
                if (!value || value.trim() === '') {
                    showMessage('è¯·è¾“å…¥é…ç½®å€¼', 'error');
                    configValueInput.focus();
                    return;
                }
                payload = JSON.stringify({
                    type: type,
                    value: value,
                    comment: comment
                });
            }

            await updateConfig(key, payload);
        });

        // --- Core Functions ---
        /**
         * å‘é€è¯·æ±‚åˆ° Workerã€‚
         * @param {string} method HTTP æ–¹æ³• (GET, PUT, DELETE)
         * @param {string} key é…ç½®é”®
         * @param {string|null} payload å¯¹äº PUT è¯·æ±‚ï¼Œè¿™æ˜¯è¦å‘é€çš„ JSON å­—ç¬¦ä¸²
         * @returns {string|null} Worker è¿”å›çš„æ–‡æœ¬ï¼Œæˆ– null å¦‚æœå¤±è´¥
         */
        async function makeRequest(method, key = '', payload = null) {
            const token = authTokenInput.value;
            if (!token) {
                showMessage('è¯·å…ˆè¾“å…¥è®¤è¯ä»¤ç‰Œã€‚', 'error');
                return null;
            }

            const url = key ? `${WORKER_URL}/${key}` : WORKER_URL;
            const headers = { 'Authorization': `Bearer ${token}` };
            const options = { method, headers };

            if (payload !== null) {
                options.body = payload; 
                headers['Content-Type'] = 'application/json'; // æ˜ç¡®å‘ŠçŸ¥ Worker å‘é€çš„æ˜¯ JSON
            }

            try {
                const response = await fetch(url, options);
                // å°è¯•è§£æJSONï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›åŸå§‹æ–‡æœ¬
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`[${response.status}] ${text || response.statusText}`);
                }
                return text;
            } catch (error) {
                showMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        async function fetchConfigList() {
            statusMessage.textContent = 'æ­£åœ¨åŠ è½½...';
            statusMessage.style.display = 'block';
            configListHead.style.display = 'none';
            configListBody.innerHTML = '';
            
            const responseText = await makeRequest('GET');
            if (responseText) {
                try {
                    const configs = JSON.parse(responseText);
                    renderConfigList(configs);
                } catch (e) {
                    showMessage('è§£æé…ç½®åˆ—è¡¨å¤±è´¥ã€‚', 'error');
                    statusMessage.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¤ç‰Œæˆ–ç½‘ç»œã€‚';
                }
            } else {
                statusMessage.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¤ç‰Œæˆ–ç½‘ç»œã€‚';
            }
        }

        /**
         * æ¸²æŸ“é…ç½®åˆ—è¡¨ã€‚
         * å‡è®¾ Worker è¿”å›çš„æ¯ä¸ªé…ç½®é¡¹éƒ½æ˜¯ { key: string, value: any }
         * å…¶ä¸­ value å¯èƒ½æ˜¯åŸå§‹å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯ Worker è§£æåçš„ JSON å¯¹è±¡ã€‚
         */
        function renderConfigList(configs) {
            if (configs.length === 0) {
                statusMessage.textContent = 'æš‚æ— é…ç½®é¡¹ï¼Œç‚¹å‡»â€œæ–°å¢é…ç½®â€æ¥æ·»åŠ ä¸€ä¸ªå§ï¼';
                statusMessage.style.display = 'block';
                configListHead.style.display = 'none';
                return;
            }

            statusMessage.style.display = 'none';
            configListHead.style.display = 'table-header-group';
            configListBody.innerHTML = '';

            configs.sort((a, b) => a.key.localeCompare(b.key)).forEach(({ key, value: rawOrParsedValue }) => {
                const row = document.createElement('tr');

                let displayValue = '';
                let displayComment = '';
                let actualValueToEdit = ''; // å­˜å‚¨ç”¨äºç¼–è¾‘çš„å€¼
                let configType = 'common'; // é»˜è®¤ç±»å‹

                // æ£€æŸ¥ Worker è¿”å›çš„ value æ˜¯åŸå§‹å­—ç¬¦ä¸²è¿˜æ˜¯å·²è§£æçš„ JSON å¯¹è±¡
                if (typeof rawOrParsedValue === 'object' && rawOrParsedValue !== null) {
                    // Worker å·²ç»è§£æä¸º { value: "...", comment: "...", type: "..." } ç»“æ„
                    displayValue = rawOrParsedValue.value !== undefined ? String(rawOrParsedValue.value) : JSON.stringify(rawOrParsedValue, null, 2);
                    displayComment = rawOrParsedValue.comment || '';
                    configType = rawOrParsedValue.type || 'common'; // è·å–ç±»å‹ï¼Œé»˜è®¤ä¸º common

                    // æ ¹æ®ç±»å‹å¤„ç† actualValueToEdit
                    if (configType === 'clash-yml' && typeof rawOrParsedValue.value === 'object') {
                        // Clash YAML ç±»å‹ï¼šä¿æŒå¯¹è±¡å½¢å¼
                        actualValueToEdit = rawOrParsedValue.value;
                    } else {
                        // å…¶ä»–ç±»å‹ï¼šè½¬æ¢ä¸ºå­—ç¬¦ä¸²
                        actualValueToEdit = rawOrParsedValue.value !== undefined ? String(rawOrParsedValue.value) : JSON.stringify(rawOrParsedValue);
                    }
                } else {
                    // Worker è¿”å›çš„æ˜¯åŸå§‹å­—ç¬¦ä¸²
                    displayValue = String(rawOrParsedValue);
                    displayComment = ''; // é»˜è®¤ä¸ºç©ºï¼Œå› ä¸ºåŸå§‹å­—ç¬¦ä¸²æ²¡æœ‰æ³¨é‡Š
                    configType = 'common'; // åŸå§‹å­—ç¬¦ä¸²é»˜è®¤ä¸º common ç±»å‹
                    actualValueToEdit = String(rawOrParsedValue);
                }

                let valueDisplayHTML;
                // ç‰¹æ®Šå¤„ç†å¸ƒå°”å€¼å¼€å…³
                if (displayValue === 'true' || displayValue === 'false') {
                    const isChecked = displayValue === 'true';
                    valueDisplayHTML = `
                        <label class="toggle-switch">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="updateBooleanConfig('${key}', event.target.checked, \`${escapeForTemplateLiteral(displayComment)}\`)">
                            <span class="slider"></span>
                        </label>
                    `;
                } else {
                    try {
                        // å°è¯•æ ¼å¼åŒ– JSON å­—ç¬¦ä¸²å€¼
                        const jsonObj = JSON.parse(displayValue);
                        valueDisplayHTML = `<div class="config-value-display"><pre>${JSON.stringify(jsonObj, null, 2)}</pre></div>`;
                    } catch (e) {
                        // å¦åˆ™æ˜¾ç¤ºä¸ºæ™®é€šæ–‡æœ¬
                        valueDisplayHTML = `<div class="config-value-display"><pre>${displayValue}</pre></div>`;
                    }
                }

                row.innerHTML = `
                    <td class="key-cell">${key}</td>
                    <td>
                        <div class="value-comment-container">
                            ${valueDisplayHTML}
                            <div class="config-comment-display">${displayComment}</div>
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm edit-btn" data-key="${key}" data-type="${configType}">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteConfig('${key}')">åˆ é™¤</button>
                        </div>
                    </td>
                `;

                // ä½¿ç”¨ data å±æ€§å­˜å‚¨é…ç½®æ•°æ®ï¼ˆæ›´å®‰å…¨ï¼‰
                const editBtn = row.querySelector('.edit-btn');
                editBtn.dataset.value = configType === 'clash-yml' ? JSON.stringify(actualValueToEdit) : actualValueToEdit;
                editBtn.dataset.comment = displayComment;
                editBtn.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const parsedValue = configType === 'clash-yml' ? JSON.parse(value) : value;
                    editConfig(this.dataset.key, parsedValue, this.dataset.comment, this.dataset.type);
                });
                configListBody.appendChild(row);
            });
        }

        /**
         * æ›´æ–°é…ç½®å€¼ï¼ˆåŒ…æ‹¬æ³¨é‡Šï¼‰ã€‚
         * @param {string} key é…ç½®é”®
         * @param {string} payload JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å« value å’Œ comment
         */
        async function updateConfig(key, payload) {
            const result = await makeRequest('PUT', key, payload);
            if (result !== null) {
                showMessage(`é…ç½® '${key}' å·²æˆåŠŸä¿å­˜ã€‚`, 'success');
                hideForm();
                fetchConfigList();
            }
        }

        /**
         * é’ˆå¯¹å¸ƒå°”å€¼å¼€å…³çš„ç‰¹æ®Šæ›´æ–°å‡½æ•°ã€‚
         * @param {string} key é…ç½®é”®
         * @param {boolean} newValue å¸ƒå°”æ–°å€¼
         * @param {string} currentComment å½“å‰çš„æ³¨é‡Šï¼Œä»¥ä¾¿åœ¨æ›´æ–°æ—¶ä¿ç•™
         */
        async function updateBooleanConfig(key, newValue, currentComment) {
            // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ currentComment
            const payload = JSON.stringify({ value: String(newValue), comment: currentComment });
            const result = await makeRequest('PUT', key, payload);
            if (result !== null) {
                showMessage(`é…ç½® '${key}' å·²æ›´æ–°ä¸º ${newValue}ã€‚`, 'success');
                fetchConfigList(); // åˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            }
        }

        async function deleteConfig(key) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® '${key}' å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                const result = await makeRequest('DELETE', key);
                if (result !== null) {
                    showMessage(`é…ç½® '${key}' å·²åˆ é™¤ã€‚`, 'success');
                    fetchConfigList();
                }
            }
        }

        // --- UI Helper Functions ---
        /**
         * ç¼–è¾‘é…ç½®æ—¶å¡«å……è¡¨å•ã€‚
         * @param {string} key é…ç½®é”®
         * @param {string} value é…ç½®å€¼ï¼ˆå·²è§£ææˆ–åŸå§‹ï¼‰
         * @param {string} comment é…ç½®æ³¨é‡Š
         * @param {string} type é…ç½®ç±»å‹ï¼ˆå¯é€‰ï¼‰
         */
        function editConfig(key, value, comment, type = 'common') {
            isEditing = true;
            currentEditingKey = key;
            formTitle.textContent = `ç¼–è¾‘: ${key}`;
            configKeyInput.value = key;
            configTypeInput.value = type;
            configCommentInput.value = comment;
            configKeyInput.disabled = true;
            configTypeInput.disabled = true;
            configFormContainer.style.display = 'block';

            const valueGroup = document.getElementById('valueGroup');

            if (type === 'clash-yml') {
                // Clash YAML ç±»å‹ï¼šåŠ è½½è§„åˆ™
                valueGroup.style.display = 'none';
                // value å¯èƒ½æ˜¯å¯¹è±¡æˆ– JSON å­—ç¬¦ä¸²
                let rulesData = null;
                if (typeof value === 'object' && value.rules) {
                    rulesData = value.rules;
                } else if (typeof value === 'string') {
                    try {
                        const parsed = JSON.parse(value);
                        rulesData = parsed.rules || [];
                    } catch (e) {
                        console.error('Failed to parse rules:', e);
                    }
                }
                clashRules = rulesData || [];
                openClashRulesEditor(key);
            } else {
                // å…¶ä»–ç±»å‹ï¼šæ˜¾ç¤ºå€¼è¾“å…¥æ¡†
                valueGroup.style.display = 'block';
                configValueInput.value = value;
                closeClashRulesEditor();
                window.scrollTo({ top: configFormContainer.offsetTop - 20, behavior: 'smooth' });
                configValueInput.focus();
            }
        }

        function hideForm() {
            configFormContainer.style.display = 'none';
            configForm.reset();
            closeClashRulesEditor();
            isEditing = false;
            currentEditingKey = null;
            clashRules = [];
        }

        function showMessage(msg, type) {
            messageBox.textContent = msg;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);
        }

        
        // ç”¨äºåœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­åµŒå…¥å˜é‡æ—¶ï¼Œé¿å… ` å’Œ $ ç¬¦å·å¼•èµ·çš„é—®é¢˜
        function escapeForTemplateLiteral(str) {
            return String(str).replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }

        // --- YAML è§£æå·¥å…·å‡½æ•° ---

        /**
         * ä» Clash YAML ä¸­æå– proxy-groups çš„ name
         * @param {string} yamlText - YAML æ–‡æœ¬å†…å®¹
         * @returns {string[]} ç­–ç•¥åç§°æ•°ç»„
         */
        function extractProxyGroups(yamlText) {
            const policies = [];
            const lines = yamlText.split('\n');
            let inProxyGroups = false;

            for (const line of lines) {
                // æ£€æµ‹ proxy-groups éƒ¨åˆ†
                if (line.trim().startsWith('proxy-groups:')) {
                    inProxyGroups = true;
                    continue;
                }

                // é€€å‡º proxy-groups éƒ¨åˆ†ï¼ˆé‡åˆ°ä¸‹ä¸€ä¸ªé¡¶çº§é”®ï¼‰
                if (inProxyGroups && line.match(/^\S[\w-]+:/)) {
                    break;
                }

                // æå– name
                const nameMatch = line.match(/^\s*-\s*name:\s*(.+)$/);
                if (nameMatch) {
                    policies.push(nameMatch[1].trim());
                }
            }

            return policies.length > 0 ? policies : ['DIRECT', 'REJECT'];
        }

        /**
         * è§£æ Clash YAML ä¸­çš„ rules éƒ¨åˆ†
         * @param {string} yamlText - YAML æ–‡æœ¬å†…å®¹
         * @returns {Array} è§„åˆ™æ•°ç»„ [{type, value, policy, enabled}]
         */
        function parseClashRules(yamlText) {
            const rules = [];
            const lines = yamlText.split('\n');
            let inRules = false;

            for (const line of lines) {
                // æ£€æµ‹ rules éƒ¨åˆ†
                if (line.trim().startsWith('rules:')) {
                    inRules = true;
                    continue;
                }

                // é€€å‡º rules éƒ¨åˆ†ï¼ˆé‡åˆ°ä¸‹ä¸€ä¸ªé¡¶çº§é”®ï¼‰
                if (inRules && line.match(/^\S[\w-]+:/)) {
                    break;
                }

                // è§£æè§„åˆ™è¡Œ: - RULE-TYPE,value,policy
                const ruleMatch = line.match(/^\s*-\s*([^,]+),([^,]+),(.+)$/);
                if (ruleMatch) {
                    rules.push({
                        type: ruleMatch[1].trim(),
                        value: ruleMatch[2].trim(),
                        policy: ruleMatch[3].trim(),
                        enabled: true
                    });
                }
            }

            return rules;
        }

        /**
         * å°†è§„åˆ™æ•°ç»„è½¬æ¢ä¸º Clash YAML æ ¼å¼
         * @param {Array} rules - è§„åˆ™æ•°ç»„
         * @returns {string} YAML æ ¼å¼çš„è§„åˆ™å­—ç¬¦ä¸²
         */
        function rulesToYAML(rules) {
            return rules
                .filter(r => r.enabled)
                .map(r => `  - ${r.type},${r.value},${r.policy}`)
                .join('\n');
        }

        /**
         * é€šè¿‡ Worker ä»£ API è·å–è¿œç¨‹ YAML å†…å®¹
         * @param {string} urlString - è¿œç¨‹ URL
         * @returns {Promise<string>} YAML æ–‡æœ¬å†…å®¹
         */
        async function fetchRemoteYAML(urlString) {
            const token = authTokenInput.value;
            if (!token) {
                throw new Error('è¯·å…ˆè¾“å…¥è®¤è¯ä»¤ç‰Œ');
            }

            const encodedUrl = encodeURIComponent(urlString);
            // ä¿®æ­£ API è·¯å¾„ï¼šç›´æ¥ä½¿ç”¨ /api/fetch-url
            const apiUrl = `/api/fetch-url?url=${encodedUrl}`;

            const response = await fetch(apiUrl, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            return await response.text();
        }

        /**
         * ä»è¿œç¨‹ URL åŠ è½½ä»£ç†ç­–ç•¥åˆ—è¡¨
         * @param {string} urlString - è¿œç¨‹é…ç½® URL
         * @returns {Promise<string[]>} ç­–ç•¥åç§°æ•°ç»„
         */
        async function loadPoliciesFromRemote(urlString) {
            try {
                const yamlText = await fetchRemoteYAML(urlString);
                const policies = extractProxyGroups(yamlText);
                showMessage(`æˆåŠŸåŠ è½½ ${policies.length} ä¸ªä»£ç†ç­–ç•¥`, 'success');
                return policies;
            } catch (error) {
                showMessage(`åŠ è½½ç­–ç•¥å¤±è´¥: ${error.message}`, 'error');
                return ['DIRECT', 'REJECT']; // è¿”å›é»˜è®¤ç­–ç•¥
            }
        }

        // --- Clash è§„åˆ™ç¼–è¾‘å™¨ ---

        // å…¨å±€è§„åˆ™æ•°ç»„
        let clashRules = [];
        let currentEditingKey = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„é…ç½®é”®

        /**
         * åˆ·æ–°ä»£ç†ç­–ç•¥åˆ—è¡¨
         */
        async function refreshPolicies() {
            const policySelect = document.getElementById('rulePolicy');
            const policySourceInfo = document.getElementById('policySourceInfo');
            // å®‰å…¨åœ°è·å–æŒ‰é’®ï¼ˆå¯èƒ½ä¸æ˜¯ä»ç‚¹å‡»äº‹ä»¶è§¦å‘çš„ï¼‰
            const refreshBtn = event && event.target ? event.target.closest('button') : null;

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'â³ åŠ è½½ä¸­...';
            }

            try {
                // æŸ¥æ‰¾ clash-github-url ç±»å‹çš„é…ç½®
                const responseText = await makeRequest('GET');
                if (!responseText) {
                    policySourceInfo.textContent = 'âŒ æ— æ³•åŠ è½½é…ç½®åˆ—è¡¨';
                    return;
                }

                const configs = JSON.parse(responseText);
                const urlConfigs = configs.filter(c => {
                    const value = c.value;
                    return value && value.type === 'clash-github-url';
                });

                if (urlConfigs.length > 0) {
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é…ç½®
                    const config = urlConfigs[0];
                    const url = config.value.value;
                    const policies = await loadPoliciesFromRemote(url);

                    // æ·»åŠ é»˜è®¤ç­–ç•¥ï¼ˆç¡®ä¿åŸºç¡€ç­–ç•¥å§‹ç»ˆå­˜åœ¨ï¼‰
                    const defaultPolicies = ['DIRECT', 'REJECT'];
                    const allPolicies = [...new Set([...defaultPolicies, ...policies])];

                    // ä¿å­˜å½“å‰é€‰ä¸­çš„ç­–ç•¥
                    const currentPolicy = policySelect.value;

                    // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
                    policySelect.innerHTML = allPolicies.map(p =>
                        `<option value="${p}">${p}</option>`
                    ).join('');

                    // å°è¯•æ¢å¤ä¹‹å‰é€‰ä¸­çš„ç­–ç•¥
                    if (allPolicies.includes(currentPolicy)) {
                        policySelect.value = currentPolicy;
                    }

                    policySourceInfo.textContent = `âœ… ä» "${config.key}" åŠ è½½äº† ${policies.length} ä¸ªç­–ç•¥ï¼ˆå«é»˜è®¤ç­–ç•¥ï¼‰`;
                    policySourceInfo.style.color = 'var(--success-color)';
                } else {
                    policySourceInfo.textContent = 'âš ï¸ æœªæ‰¾åˆ° clash-github-url ç±»å‹çš„é…ç½®ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªè¿œç¨‹é…ç½®';
                    policySourceInfo.style.color = 'var(--warning-color)';
                }
            } catch (error) {
                console.error('åˆ·æ–°ç­–ç•¥å¤±è´¥:', error);
                policySourceInfo.textContent = `âŒ åˆ·æ–°å¤±è´¥: ${error.message}`;
                policySourceInfo.style.color = 'var(--danger-color)';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ç­–ç•¥';
                }
            }
        }

        /**
         * æ ¹æ®è§„åˆ™ç±»å‹æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
         */
        function updateRulePlaceholder() {
            const ruleType = document.getElementById('ruleType').value;
            const ruleValueInput = document.getElementById('ruleValue');

            const placeholders = {
                'DOMAIN-SUFFIX': 'google.com\nyoutube.com\ngmail.com',
                'DOMAIN': 'www.google.com\napi.github.com',
                'DOMAIN-KEYWORD': 'google\nfacebook\ntwitter',
                'IP-CIDR': '192.168.1.0/24\n10.0.0.0/8',
                'GEOIP': 'CN\nUS\nJP\nHK',
                'SRC-IP-CIDR': '192.168.1.0/24\n10.0.0.0/8'
            };

            ruleValueInput.placeholder = placeholders[ruleType] || 'è¾“å…¥è§„åˆ™å†…å®¹';
        }

        /**
         * å¡«å……è§„åˆ™ç¤ºä¾‹
         */
        function fillRuleExample() {
            const ruleType = document.getElementById('ruleType').value;
            const ruleValueInput = document.getElementById('ruleValue');

            let examples = [];

            switch (ruleType) {
                case 'DOMAIN-SUFFIX':
                    examples = [
                        'google.com',
                        'googleapis.com',
                        'googleusercontent.com',
                        'youtube.com',
                        'gmail.com'
                    ];
                    break;
                case 'DOMAIN':
                    examples = [
                        'www.google.com',
                        'api.github.com',
                        'cdn.jsdelivr.net'
                    ];
                    break;
                case 'DOMAIN-KEYWORD':
                    examples = [
                        'google',
                        'facebook',
                        'youtube',
                        'twitter'
                    ];
                    break;
                case 'IP-CIDR':
                    examples = [
                        '192.168.1.0/24',
                        '10.0.0.0/8',
                        '172.16.0.0/12'
                    ];
                    break;
                case 'GEOIP':
                    examples = [
                        'CN',
                        'US',
                        'JP',
                        'HK'
                    ];
                    break;
                case 'SRC-IP-CIDR':
                    examples = [
                        '192.168.1.0/24',
                        '10.0.0.0/8'
                    ];
                    break;
                default:
                    examples = ['example.com'];
            }

            ruleValueInput.value = examples.join('\n');
            showMessage('å·²å¡«å……ç¤ºä¾‹ï¼Œç‚¹å‡»"æ·»åŠ è§„åˆ™"æ‰¹é‡æ·»åŠ ', 'info');
        }

        /**
         * æ·»åŠ è§„åˆ™åˆ°åˆ—è¡¨
         */
        function addRule() {
            const ruleType = document.getElementById('ruleType').value;
            const ruleValueInput = document.getElementById('ruleValue');
            const ruleValue = ruleValueInput.value.trim();
            const rulePolicy = document.getElementById('rulePolicy').value;

            if (!ruleValue) {
                showMessage('è¯·è¾“å…¥è§„åˆ™å†…å®¹', 'error');
                return;
            }

            // æ”¯æŒå¤šè¡Œè¾“å…¥ï¼šæŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œ
            const lines = ruleValue
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (lines.length === 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è§„åˆ™å†…å®¹', 'error');
                return;
            }

            // æ‰¹é‡æ·»åŠ è§„åˆ™
            let addedCount = 0;
            lines.forEach(line => {
                clashRules.push({
                    type: ruleType,
                    value: line,
                    policy: rulePolicy,
                    enabled: true
                });
                addedCount++;
            });

            // æ¸…ç©ºè¾“å…¥æ¡†
            ruleValueInput.value = '';

            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderRulesList();

            // æ˜¾ç¤ºæ·»åŠ ç»“æœ
            if (addedCount > 1) {
                showMessage(`æˆåŠŸæ·»åŠ  ${addedCount} æ¡è§„åˆ™`, 'success');
            } else {
                showMessage('è§„åˆ™å·²æ·»åŠ ', 'success');
            }
        }

        /**
         * æ¸²æŸ“è§„åˆ™åˆ—è¡¨
         */
        function renderRulesList() {
            const rulesList = document.getElementById('rulesList');
            const noRulesMessage = document.getElementById('noRulesMessage');
            const ruleCount = document.getElementById('ruleCount');

            if (clashRules.length === 0) {
                rulesList.innerHTML = '';
                noRulesMessage.style.display = 'block';
                ruleCount.textContent = '';
                return;
            }

            noRulesMessage.style.display = 'none';
            ruleCount.textContent = `(å…± ${clashRules.length} æ¡)`;

            rulesList.innerHTML = clashRules.map((rule, index) => `
                <div class="rule-item ${!rule.enabled ? 'disabled' : ''}">
                    <div class="rule-toggle">
                        <input type="checkbox" ${rule.enabled ? 'checked' : ''}
                            onchange="toggleRule(${index})"
                            style="cursor: pointer;">
                    </div>
                    <div class="rule-content">
                        <span class="rule-type-tag rule-type-${rule.type}">${rule.type}</span>
                        <span class="rule-value">${rule.value}</span>
                        <span class="rule-arrow">â†’</span>
                        <span class="rule-policy">${rule.policy}</span>
                    </div>
                    <div class="rule-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editRule(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRule(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * åˆ‡æ¢è§„åˆ™å¯ç”¨çŠ¶æ€
         */
        function toggleRule(index) {
            clashRules[index].enabled = !clashRules[index].enabled;
            renderRulesList();
        }

        /**
         * ç¼–è¾‘è§„åˆ™
         */
        function editRule(index) {
            const rule = clashRules[index];
            document.getElementById('ruleType').value = rule.type;
            document.getElementById('ruleValue').value = rule.value;
            document.getElementById('rulePolicy').value = rule.policy;

            // åˆ é™¤åŸè§„åˆ™
            clashRules.splice(index, 1);
            renderRulesList();
        }

        /**
         * åˆ é™¤è§„åˆ™
         */
        function deleteRule(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
                clashRules.splice(index, 1);
                renderRulesList();
                showMessage('è§„åˆ™å·²åˆ é™¤', 'success');
            }
        }

        /**
         * å¯¼å‡ºè§„åˆ™ä¸º YAML æ ¼å¼
         */
        function exportRulesAsYAML() {
            if (clashRules.length === 0) {
                showMessage('æš‚æ— è§„åˆ™å¯å¯¼å‡º', 'error');
                return;
            }

            const yaml = rulesToYAML(clashRules);

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText('rules:\n' + yaml).then(() => {
                showMessage('YAML å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                // é™çº§ï¼šæ˜¾ç¤ºåœ¨æ–°çª—å£
                const newWindow = window.open('', '_blank');
                newWindow.document.write('<pre>' + 'rules:\n' + yaml + '</pre>');
            });
        }

        /**
         * ä¿å­˜è§„åˆ™åˆ°é…ç½®
         */
        async function saveRulesToConfig() {
            // æ£€æŸ¥æ˜¯å¦æœ‰è§„åˆ™
            if (clashRules.length === 0) {
                showMessage('è¯·æ·»åŠ è‡³å°‘ä¸€æ¡è§„åˆ™', 'error');
                return;
            }

            // å¦‚æœæ²¡æœ‰ currentEditingKeyï¼Œä½¿ç”¨é…ç½®é”®è¾“å…¥æ¡†çš„å€¼
            let key = currentEditingKey;
            if (!key) {
                key = configKeyInput.value.trim();
                if (!key) {
                    showMessage('è¯·è¾“å…¥é…ç½®é”®ï¼ˆåœ¨è¡¨å•ä¸­å¡«å†™ï¼‰', 'error');
                    configKeyInput.focus();
                    return;
                }
            }

            const payload = JSON.stringify({
                type: 'clash-yml',
                value: {
                    rules: clashRules
                },
                comment: `Clash è§„åˆ™é…ç½® (${clashRules.length} æ¡)`
            });

            await updateConfig(key, payload);

            // å¦‚æœæ˜¯æ–°å¢é…ç½®ï¼Œä¿å­˜æˆåŠŸåæ›´æ–° currentEditingKey
            if (!currentEditingKey) {
                currentEditingKey = key;
            }
        }

        /**
         * æ‰“å¼€ Clash è§„åˆ™ç¼–è¾‘å™¨
         */
        function openClashRulesEditor(configKey = null) {
            currentEditingKey = configKey;

            // æ¸²æŸ“è§„åˆ™åˆ—è¡¨ï¼ˆclashRules åº”è¯¥å·²ç»åœ¨å¤–éƒ¨åŠ è½½ï¼‰
            renderRulesList();
            document.getElementById('clashRulesEditor').style.display = 'block';

            // è‡ªåŠ¨åˆ·æ–°ç­–ç•¥åˆ—è¡¨
            refreshPolicies();
        }

        /**
         * å…³é—­ Clash è§„åˆ™ç¼–è¾‘å™¨
         */
        function closeClashRulesEditor() {
            document.getElementById('clashRulesEditor').style.display = 'none';
            // ä¸è¦æ¸…ç©º clashRules å’Œ currentEditingKeyï¼Œå› ä¸ºå¯èƒ½åœ¨ç¼–è¾‘è¿‡ç¨‹ä¸­
            // ä»…åœ¨ hideForm æ—¶æ¸…ç©º
        }
    </script>
</body>
</html>
